generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PLAYER
  COACH
  ADMIN
}

enum PlayerPosition {
  GOALKEEPER
  DEFENDER
  MIDFIELDER
  FORWARD
}

enum MealType {
  BREAKFAST
  SNACK
  LUNCH
  DINNER
  EVENING_SNACK
  AFTER_PRACTICE
}

model User {
  id                   String           @id @default(uuid())
  clerkId              String?          @unique  // Legacy field, now optional
  supabaseId           String?          @unique  // Primary authentication field for Supabase
  email                String           @unique
  name                 String
  age                  Int
  role                 UserRole         @default(PLAYER)
  position             PlayerPosition?
  parentEmail          String?
  dataConsent          Boolean          @default(false)
  teamId               String?
  team                 Team?            @relation(fields: [teamId], references: [id])
  
  // Onboarding fields
  ageGroup             String?          // '10-12', '13-15', '16-18', '19-25'
  goals                String[]         @default([])
  trainingDaysPerWeek  Int              @default(3)
  completedOnboarding  Boolean          @default(false)
  onboardingDate       DateTime?
  preferences          Json?            // Stores user preferences as JSON
  
  // Relations
  foodEntries          FoodEntry[]
  performanceMetrics   PerformanceMetric[]
  teams                TeamMember[]
  nutritionGoals       NutritionGoal[]
  achievements         Achievement[]
  
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  deletedAt            DateTime?

  @@index([clerkId])
  @@index([email])
  @@index([teamId])
}

model Team {
  id          String       @id @default(uuid())
  name        String
  inviteCode  String       @unique @default(cuid())
  description String?
  coachId     String?
  players     User[]       // Legacy relation, use TeamMember for new features
  members     TeamMember[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([inviteCode])
  @@index([coachId])
}

model TeamMember {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id])
  role      String   @default("PLAYER") // PLAYER, COACH, ASSISTANT
  joinedAt  DateTime @default(now())
  
  @@unique([userId, teamId])
  @@index([userId])
  @@index([teamId])
}

model FoodEntry {
  id             String    @id @default(uuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id])
  date           DateTime
  mealType       MealType
  time           String
  location       String?
  description    String
  notes          String?
  
  // Nutrition analysis fields
  nutritionScore Int?      // 0-100 score
  quality        String?   // 'poor' | 'fair' | 'good' | 'excellent'
  calories       Int?      // Estimated calories
  protein        Int?      // Grams of protein
  carbs          Int?      // Grams of carbs
  fats           Int?      // Grams of fats
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId, date])
  @@index([date])
}

model PerformanceMetric {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  date           DateTime
  energyLevel    Int      // 1-5 scale
  sleepHours     Float    // Auto-calculated from bedTime and wakeTime
  bedTime        String?  // Time when went to bed (e.g., "22:30")
  wakeTime       String?  // Time when woke up (e.g., "06:45")
  isTrainingDay  Boolean  @default(false)
  trainingType   String?
  matchDay       Boolean  @default(false)
  recoveryLevel  Int?     // 1-5 scale: 1=very sore, 5=fully recovered
  hadRecoveryMeal Boolean @default(false) // Track if had post-practice meal
  recoveryNotes  String?  // Notes about recovery (muscle soreness, fatigue, etc)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
  @@index([date])
}

model NutritionGoal {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  goalType    String    // 'daily_calories', 'protein_intake', 'carbs_intake', 'water_intake'
  targetValue Float     // Target value for the goal
  unit        String    // 'calories', 'grams', 'liters', etc.
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean   @default(true)
  progress    Float     @default(0) // Current progress towards goal
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([goalType])
  @@index([isActive])
}

model Achievement {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  type        String   // 'streak', 'nutrition_score', 'consistency', 'milestone'
  name        String   // Achievement name
  description String   // Achievement description
  icon        String?  // Icon identifier for UI
  earnedAt    DateTime @default(now())
  metadata    Json?    // Additional achievement data (streak count, score, etc.)
  
  @@index([userId])
  @@index([type])
  @@index([earnedAt])
}

model FoodLibrary {
  id            String   @id @default(uuid())
  name          String   @unique
  nameFi        String?  // Finnish name
  category      String   // 'protein', 'carbs', 'vegetables', 'fruits', 'dairy', 'snacks'
  subcategory   String?  // More specific categorization
  nutritionData Json     // Detailed nutrition info per 100g
  servingSizes  Json?    // Common serving sizes
  isNordic      Boolean  @default(false) // Nordic/Finnish food
  isVerified    Boolean  @default(false) // Verified by nutritionist
  tags          String[] // Tags for search and filtering
  barcode       String?  // Product barcode if applicable
  brand         String?  // Brand name if applicable
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([category])
  @@index([isNordic])
  @@index([isVerified])
  @@index([name])
}
